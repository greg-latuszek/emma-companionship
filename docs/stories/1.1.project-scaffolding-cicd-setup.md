# Story 1.1: Project Scaffolding & CI/CD Setup

## Status
Draft

## Story
**As a** Product Owner,
**I want** the project monorepo and a basic CI/CD pipeline to be set up,
**so that** we have a stable, automated foundation for development and deployment from day one.

## Acceptance Criteria
1. A monorepo is created and initialized with a basic folder structure for the backend and frontend applications.
   - Verification: `nx graph` and `nx build web` succeed; required directories exist per Unified Project Structure.
2. A "Health Check" endpoint exists on the backend that returns a 200 OK status.
   - Verification: GET `/api/health` returns 200 and `{ "status": "ok" }`.
3. CI pipeline preparation is completed and quality gates are runnable locally (install deps, lint, type-check, tests).
   - POC Acceptance: CI workflow file `.github/workflows/ci-cd.yml` is present but disabled; local parity commands verified.
4. Deployment path is operable for the POC.
   - POC Acceptance: Manual Vercel deployment steps are documented and executed; deployed `/api/health` responds 200.

## Tasks / Subtasks
- [ ] Initialize Nx monorepo and baseline structure (AC: 1)
  - [ ] Scaffold Nx workspace with Next.js app `web` and enable pnpm workspaces (AC: 1)
  - [ ] Create base folders per Unified Project Structure (apps/web, packages/shared-types, packages/ui, packages/config) (AC: 1) [Source: architecture/unified-project-structure.md#unified-project-structure]
  - [ ] Add baseline configs: `nx.json`, root `package.json`, TS/ESLint/Prettier using Nx defaults (AC: 1) [Source: architecture/development-workflow.md#development-commands]
- [ ] Add core dependencies and scripts (AC: 1)
  - [ ] Install Next.js, TypeScript, Prisma, Auth.js, Tailwind CSS, TanStack Query; set up root and app-level scripts (AC: 1) [Source: architecture/tech-stack.md#technology-stack-table]
  - [ ] Add Docker Compose at repo root (`docker-compose.yml`) for local PostgreSQL and pnpm scripts for DB lifecycle (AC: 1) [Source: architecture/development-workflow.md#local-development-setup]
- [ ] Implement backend health check endpoint (AC: 2)
  - [ ] Create `/apps/web/src/app/api/health/route.ts` returning `{ status: 'ok' }` with HTTP 200 (AC: 2) [Source: architecture/deployment-architecture.md#deployment-strategy]
  - [ ] Add a simple test to assert 200 OK response (AC: 2) [Source: architecture/testing-strategy.md#backend-tests]
- [ ] Establish baseline quality gates (AC: 3)
  - [ ] Configure `pnpm lint`, `pnpm type-check`, and `pnpm test` to run in repo root (AC: 3) [Source: architecture/development-workflow.md#development-commands]
  - [ ] Ensure Nx targets exist: `nx lint web`, `nx test web`, `nx build web` (AC: 3) [Source: architecture/development-workflow.md#nx-workspace-commands-alongside-pnpm-scripts]
- [ ] CI/CD enablement (see note) (AC: 3, 4)
  - [ ] Add GitHub Actions workflow `.github/workflows/ci-cd.yml` to run type-check, lint, unit/integration tests, and build (AC: 3) [Source: architecture/deployment-architecture.md#planned-github-actions-ci/cd]
  - [ ] Configure preview deploy to Vercel using `vercel build` and `vercel deploy --prebuilt` (AC: 4) [Source: architecture/deployment-architecture.md#poc-manual-deployment-vercel]
  - [ ] Configure production deployment on `main` with post-deploy DB migrate step (AC: 4) [Source: architecture/deployment-architecture.md#planned-github-actions-ci/cd]
  - [ ] POC: Keep CI disabled; document and verify manual Vercel deployment path (see Manual Deployment Checklist) [Source: architecture/deployment-architecture.md#poc-manual-deployment-vercel]

## Dev Notes

- Monorepo & Tooling
  - Use Nx as the monorepo tool with task graph and caching. Scaffold `apps/web` as Next.js fullstack app and prepare `packages/` for shared types/components/config. [Source: architecture/unified-project-structure.md#unified-project-structure]
  - Keep structure aligned to Unified Project Structure (apps/web/src/app, components, hooks, lib/api, lib/modules, etc.). [Source: architecture/unified-project-structure.md#unified-project-structure]
  - Core technologies: Next.js App Router, TypeScript, Prisma, Auth.js, TanStack Query; React Flow is planned for a later phase. [Source: architecture/tech-stack.md#technology-stack-table]

- Development Workflow
  - Baseline commands exist for install, dev, build, lint, format, type-check, and tests; Nx equivalents should be available (`nx serve web`, `nx build web`, `nx test web`, `nx lint web`, `nx graph`). [Source: architecture/development-workflow.md#development-commands]
  - Local DB via Docker Compose, with scripts for `db:start`, `db:generate`, `db:migrate`, `db:seed`. [Source: architecture/development-workflow.md#local-development-setup]

- Health Check Endpoint
  - Implement health route under Next.js API routes to validate serverless readiness and provide CI smoke checks. [Source: architecture/deployment-architecture.md#deployment-strategy]

- CI/CD and Deployment
  - Architecture documents a planned GitHub Actions pipeline and a POC manual deploy path via Vercel CLI; for this story, include the pipeline file and parameters to satisfy AC 3–4, with clear toggles to allow interim manual deploy if needed. [Source: architecture/deployment-architecture.md#poc-manual-deployment-vercel]

### Testing
- Follow the Testing Strategy pyramid; for this story add:
  - Unit test for health endpoint (Backend Unit). [Source: architecture/testing-strategy.md#backend-tests]
  - Optional integration smoke in CI to hit `/api/health` after build. [Source: architecture/testing-strategy.md#e2e-tests-planned]
- Use Jest + Supertest for API route tests. [Source: architecture/tech-stack.md#technology-stack-table]

### Secrets and Environment
- Use managed secrets: Vercel environment variables and GitHub Actions `secrets.*` (when CI enabled). Never commit secrets.
- Provide `.env.local` in repo root and `apps/web/.env.local` for app; ensure `NEXTAUTH_SECRET` and DB URLs are set locally only.
- Add fast‑fail env validation (basic for POC); consider `@t3-oss/env-nextjs` as a future enhancement.

### Manual Deployment Checklist (POC)
1. `npm i -g vercel` and `vercel login` (once per machine) [Source: architecture/deployment-architecture.md#poc-manual-deployment-vercel]
2. `vercel link` (link the project)
3. `vercel build`
4. `vercel deploy --prebuilt` (preview) or `vercel deploy --prebuilt --prod` (production)
5. Verify deployed `/api/health` returns 200 and `{status:'ok'}`

### Script Mapping (Convenience)
- pnpm: `pnpm dev` ↔ Nx: `nx serve web`
- pnpm: `pnpm build:web` ↔ Nx: `nx build web`
- pnpm: `pnpm test:web` ↔ Nx: `nx test web`
- pnpm: `pnpm lint` ↔ Nx: `nx lint web`

### Project Structure Notes
- The PRD AC requires a running CI pipeline and auto-deploy on every commit (AC 3–4). Current architecture notes mark GitHub Actions as “planned” for POC with a manual Vercel deployment path. For consistency, we will:
  - Keep the Actions workflow file present but disabled (e.g., limited triggers or temporarily commented triggers) while using manual deploys, documenting this exception until CI is formally enabled. [Source: architecture/deployment-architecture.md#planned-github-actions-ci/cd]
  - Document and verify the manual Vercel deployment path during this story. [Source: architecture/deployment-architecture.md#poc-manual-deployment-vercel]

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-18 | 0.1.0 | Initial draft created from Epic 1.1 and architecture v4 | Scrum Master |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
